{% extends 'base.html' %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-6" id="live">
    <div class="section-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>1. 라이브 녹화</h4>
        <span class="badge rounded-pill bg-primary">녹화 컨트롤</span>
      </div>
      <form method="post" action="{{ url_for('record_live_action') }}" class="mb-2" id="live-form">
        <label class="form-label" for="live_url">라이브 주소</label>
        <div class="input-group mb-2">
          <input name="live_url" id="live_url" type="url" class="form-control" placeholder="https://www.youtube.com/live/..." />
          <span class="input-group-text bg-light" id="live-timer" role="status" aria-live="polite">대기 중</span>
        </div>
        <div class="btn-group w-100" role="group">
          <button class="btn btn-outline-primary" name="action" value="녹화 시작">녹화 시작</button>
          <button class="btn btn-outline-secondary" name="action" value="일시정지">일시정지</button>
          <button class="btn btn-outline-danger" name="action" value="종료">종료</button>
          <button class="btn btn-outline-success" name="action" value="업로드">업로드</button>
          <button type="button" class="btn btn-outline-info" id="live-search-button">검색</button>
          <button type="button" class="btn btn-outline-dark" id="live-capture-button">캡처</button>
        </div>
        <div class="form-text text-danger" id="live-status" aria-live="polite"></div>
      </form>
      <div class="live-preview mt-3" id="live-preview-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">라이브 미리보기</h6>
          <span class="badge bg-light text-dark">YouTube</span>
        </div>
        <div class="ratio ratio-16x9 border rounded overflow-hidden bg-light" id="live-preview-shell">
          <iframe
            id="live-preview-frame"
            title="YouTube 라이브 미리보기"
            allowfullscreen
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            class="d-none"
          ></iframe>
          <div class="d-flex align-items-center justify-content-center h-100 text-muted" id="live-preview-placeholder">
            라이브 링크를 검색하면 스트리밍 화면이 나타납니다.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6" id="download-box">
    <div class="section-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>2. 링크 다운로드</h4>
        <span class="badge bg-light text-dark">진행률 표시</span>
      </div>
      <form id="download-form">
        <label class="form-label" for="video_url">다운로드할 링크</label>
        <div class="input-group mb-2">
          <input name="video_url" id="video_url" type="url" class="form-control" placeholder="https://www.youtube.com/..." required />
          <button class="btn btn-primary" type="submit">다운로드</button>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="on" id="upload_after" name="upload_after" />
          <label class="form-check-label" for="upload_after">다운로드 후 원드라이브 업로드 예약</label>
        </div>
        <div class="progress mb-2 d-none" id="download-progress">
          <div class="progress-bar" role="progressbar" style="width: 0%" id="download-progress-bar"></div>
        </div>
        <div class="small text-muted" id="download-status">대기 중</div>
      </form>
    </div>
  </div>

  <div class="col-lg-6" id="transcript">
    <div class="section-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>3. 전사 및 요약</h4>
        <span class="badge bg-light text-dark">진행률 실시간 표시</span>
      </div>

      <form method="post" action="{{ url_for('transcript_action') }}" class="mb-4">
        <div class="d-flex justify-content-between mb-2">
          <h6 class="mb-0">전사</h6>
          <small class="text-muted">자동 업로드: {{ settings.paths.transcript_upload }}</small>
        </div>
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <select class="form-select" name="file_name">
              {% for cat in categories %}
              <optgroup label="{{ cat.name }}">
                {% for f in cat.files %}
                <option>{{ f }}</option>
                {% endfor %}
              </optgroup>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-primary">전사 시작</button>
          </div>
        </div>
        <div class="progress mt-2">
          <div class="progress-bar {{ jobs.transcript.active|percent_class }}" style="width: {{ jobs.transcript.active }}%"></div>
        </div>
      </form>

      <form method="post" action="{{ url_for('summary_action') }}">
        <div class="d-flex justify-content-between mb-2">
          <h6 class="mb-0">요약</h6>
          <small class="text-muted">자동 업로드: {{ settings.paths.summary_upload }}</small>
        </div>
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <select class="form-select" name="file_name">
              {% for cat in categories %}
              <optgroup label="{{ cat.name }}">
                {% for f in cat.files %}
                <option>{{ f }}</option>
                {% endfor %}
              </optgroup>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-success">요약 시작</button>
          </div>
        </div>
        <div class="progress mt-2">
          <div class="progress-bar {{ jobs.summary.active|percent_class }}" style="width: {{ jobs.summary.active }}%"></div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row g-3 mt-2" id="settings">
  <div class="col-12">
    <div class="section-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>4. 설정</h4>
        <span class="badge bg-info text-dark">경로 &amp; 인증서</span>
      </div>
      <div class="alert alert-warning d-flex align-items-center" role="alert">
        <div>
          <div class="fw-semibold">HTTPS 상태</div>
          {% if https_state.active %}
          <div class="small mb-1">인증서 주체: {{ https_state.cert_subject or '확인되지 않음' }}</div>
          <div class="small mb-0">신뢰할 수 있는 CA에서 발급된 인증서를 사용하고, IP 대신 인증서에 포함된 도메인으로 접속하면 경고 없이 바로 열립니다.</div>
          {% else %}
          <div class="small mb-0">{{ https_state.message }}. SSL_CERT_FILE/SSL_KEY_FILE 환경변수에 CA가 서명한 인증서를 지정하세요.</div>
          {% endif %}
        </div>
      </div>
      <form method="post" action="{{ url_for('settings_action') }}" class="row g-3">
        <div class="col-12">
          <h6 class="text-muted mb-2">녹화 · 다운로드 저장소</h6>
        </div>
        <div class="col-md-4">
          <label class="form-label">링크 다운로드 저장 위치</label>
          <input class="form-control" name="downloads" value="{{ settings.paths.downloads }}" />
        </div>
        <div class="col-md-4">
          <label class="form-label">라이브 녹화 저장</label>
          <input class="form-control" name="recordings" value="{{ settings.paths.recordings }}" />
        </div>
        <div class="col-md-4">
          <label class="form-label">캡처 저장 위치</label>
          <input class="form-control" name="captures" value="{{ settings.paths.captures }}" />
        </div>

        <div class="col-md-4">
          <label class="form-label">전사 저장 위치</label>
          <input class="form-control" name="transcripts" value="{{ settings.paths.transcripts }}" />
        </div>

        <div class="col-md-4">
          <label class="form-label">요약 저장 위치</label>
          <input class="form-control" name="summaries" value="{{ settings.paths.summaries }}" />
        </div>
        <div class="col-12">
          <h6 class="text-muted mb-2">자동 업로드 경로 (Google Drive)</h6>
        </div>
        <div class="col-md-4">
          <label class="form-label">전사 업로드 경로</label>
          <div class="input-group mb-1">
            <input class="form-control gdrive-path-input" name="transcript_upload" id="transcript_upload" value="{{ settings.paths.transcript_upload }}" />
            <button class="btn btn-outline-secondary gdrive-path-button" data-target="transcript-upload-select" type="button">경로 불러오기</button>
          </div>
          <select class="form-select gdrive-path-select d-none" id="transcript-upload-select" data-bind-input="transcript_upload"></select>
          <small class="text-muted">rclone으로 연결된 Google Drive 폴더를 선택하세요.</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">요약 업로드 경로</label>
          <div class="input-group mb-1">
            <input class="form-control gdrive-path-input" name="summary_upload" id="summary_upload" value="{{ settings.paths.summary_upload }}" />
            <button class="btn btn-outline-secondary gdrive-path-button" data-target="summary-upload-select" type="button">경로 불러오기</button>
          </div>
          <select class="form-select gdrive-path-select d-none" id="summary-upload-select" data-bind-input="summary_upload"></select>
          <small class="text-muted">폴더를 선택해 요약본 업로드 위치를 고를 수 있습니다.</small>
        </div>

        <div class="col-md-6">
          <label class="form-label">일반 업로드 경로</label>
          <div class="input-group mb-1">
            <input class="form-control gdrive-path-input" name="gdrive_upload" id="gdrive_upload" value="{{ settings.paths.gdrive_upload }}" />
            <button class="btn btn-outline-secondary gdrive-path-button" data-target="general-upload-select" type="button">경로 불러오기</button>
          </div>
          <select class="form-select gdrive-path-select d-none" id="general-upload-select" data-bind-input="gdrive_upload"></select>
          <small class="text-muted">불러온 경로 중 원하는 폴더를 골라 업로드 경로로 설정하세요.</small>
        </div>
        <div class="col-md-3">
          <label class="form-label">ChatGPT 토큰</label>
          <input class="form-control" name="chatgpt_token" value="{{ settings.auth.chatgpt_token }}" />
        </div>
        <div class="col-md-3">
          <label class="form-label">rclone 원격 이름 (Google Drive)</label>
          <input class="form-control" name="gdrive_remote" value="{{ settings.auth.gdrive_remote }}" />
          <small class="text-muted">기본값: gdrive</small>
        </div>

        <div class="col-12 d-flex justify-content-between align-items-center">
          <div>
            <span class="badge bg-light text-dark">자동 업로드</span>
            <small class="text-muted ms-2">전사/요약 완료 후 Google Drive에 바로 반영됩니다.</small>
          </div>
          <button class="btn btn-primary">설정 저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row g-3 mt-2">
  <div class="col-12">
    <div class="section-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">추천 기능</h6>
        <span class="badge bg-secondary">추가 아이디어</span>
      </div>
      <ul class="mb-0">
        <li>Google Drive 업로드 히스토리 로그 제공</li>
        <li>짧은 요약/긴 요약/하이라이트 3단 요약 옵션</li>
        <li>작업 실패 시 자동 재시도 및 이메일 알림</li>
      </ul>
    </div>
  </div>
</div>
<script>
  const liveForm = document.getElementById("live-form");
  const liveUrlInput = document.getElementById("live_url");
  const liveStatus = document.getElementById("live-status");
  const liveTimer = document.getElementById("live-timer");
  const livePreviewFrame = document.getElementById("live-preview-frame");
  const livePreviewPlaceholder = document.getElementById("live-preview-placeholder");
  const liveSearchButton = document.getElementById("live-search-button");
  const liveCaptureButton = document.getElementById("live-capture-button");
  const LIVE_TIMER_KEY = "yt-helper-live-started-at";
  let liveTimerId;

  const setLiveStatus = (message, variant = "text-danger") => {
    if (!liveStatus) return;
    liveStatus.className = `form-text ${variant}`;
    liveStatus.textContent = message || "";
  };

  const isLiveUrl = (value) => {
    if (!value) return false;
    const normalized = value.toLowerCase();
    return ["youtube.com/live", "youtu.be", "live.youtube.com"].some((key) => normalized.includes(key));
  };

  const extractYoutubeId = (value) => {
    if (!value) return null;

    const idPattern = /^[a-zA-Z0-9_-]{6,}$/;
    if (idPattern.test(value) && !value.includes("/")) {
      return value;
    }

    try {
      const url = new URL(value);
      const host = url.hostname.replace(/^www\./, "").toLowerCase();

      if (host === "youtu.be") {
        return url.pathname.split("/").filter(Boolean)[0] || null;
      }

      if (host.endsWith("youtube.com")) {
        const byParam = url.searchParams.get("v");
        if (byParam) return byParam;

        const parts = url.pathname.split("/").filter(Boolean);
        if (parts[0] === "live" && parts[1]) return parts[1];
        if (parts[0] === "embed" && parts[1]) return parts[1];
      }
    } catch (error) {
      return null;
    }

    return null;
  };

  const showLivePreview = (embedUrl) => {
    if (!livePreviewFrame || !livePreviewPlaceholder) return;
    livePreviewFrame.src = embedUrl;
    livePreviewFrame.classList.remove("d-none");
    livePreviewPlaceholder.classList.add("d-none");
  };

  const formatElapsed = (ms) => {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
    const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
    const seconds = String(totalSeconds % 60).padStart(2, "0");
    return `${hours}:${minutes}:${seconds}`;
  };

  const stopLiveTimer = () => {
    if (liveTimerId) {
      clearInterval(liveTimerId);
    }
    if (liveTimer) {
      liveTimer.textContent = "대기 중";
      liveTimer.classList.remove("text-primary", "fw-semibold");
    }
    liveTimerId = undefined;
  };

  const startLiveTimer = (startedAt) => {
    if (!liveTimer) return;
    const origin = Number(startedAt);
    if (Number.isNaN(origin)) return;
    stopLiveTimer();
    const render = () => {
      const elapsed = Date.now() - origin;
      liveTimer.textContent = `녹화 ${formatElapsed(elapsed)}`;
    };
    render();
    liveTimer.classList.add("text-primary", "fw-semibold");
    liveTimerId = setInterval(render, 1000);
  };

  const resumeLiveTimer = () => {
    const saved = localStorage.getItem(LIVE_TIMER_KEY);
    if (saved) {
      startLiveTimer(Number(saved));
    }
  };

  if (liveForm && liveUrlInput) {
    resumeLiveTimer();

    liveForm.addEventListener("submit", (event) => {
      const action = event.submitter?.value;
      const liveUrl = liveUrlInput.value.trim();

      if (action === "녹화 시작") {
        if (!liveUrl) {
          event.preventDefault();
          setLiveStatus("라이브 주소를 입력하세요.");
          return;
        }
        if (!isLiveUrl(liveUrl)) {
          event.preventDefault();
          setLiveStatus("라이브 링크를 넣어주세요. 실시간 스트림 주소를 확인하세요.");
          return;
        }
        const now = Date.now();
        localStorage.setItem(LIVE_TIMER_KEY, now.toString());
        startLiveTimer(now);
        setLiveStatus("라이브 녹화를 시작했습니다.", "text-success");
      } else if (action === "종료") {
        localStorage.removeItem(LIVE_TIMER_KEY);
        stopLiveTimer();
        setLiveStatus("녹화를 종료했습니다.", "text-muted");
      } else if (action === "일시정지") {
        setLiveStatus("녹화를 일시정지했습니다.", "text-muted");
      } else if (action === "업로드") {
        setLiveStatus("업로드를 시작합니다.", "text-muted");
      }
    });
  }

  if (liveSearchButton && liveUrlInput) {
    liveSearchButton.addEventListener("click", () => {
      const liveUrl = liveUrlInput.value.trim();

      if (!liveUrl) {
        setLiveStatus("라이브 주소를 입력하세요.");
        return;
      }

      if (!isLiveUrl(liveUrl)) {
        setLiveStatus("라이브 링크를 넣어주세요. 실시간 스트림 주소를 확인하세요.");
        return;
      }

      const videoId = extractYoutubeId(liveUrl);
      if (!videoId) {
        setLiveStatus("유튜브 링크에서 영상 ID를 찾지 못했습니다.", "text-danger");
        return;
      }

      const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1`;
      showLivePreview(embedUrl);
      setLiveStatus("스트리밍 화면을 불러왔습니다.", "text-success");
    });
  }

  const captureLivePreview = async () => {
    const liveUrl = liveUrlInput?.value?.trim();
    if (!liveUrl) {
      setLiveStatus("라이브 주소를 입력한 뒤 캡처하세요.", "text-danger");
      return;
    }

    if (!isLiveUrl(liveUrl)) {
      setLiveStatus("유튜브 라이브 링크가 맞는지 확인하세요.", "text-danger");
      return;
    }

    setLiveStatus("서버에서 스트리밍을 캡처하는 중입니다...", "text-muted");

    try {
      const response = await fetch("{{ url_for('capture_live_action') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ live_url: liveUrl }),
      });

      const payload = await response.json();
      if (response.ok && payload.ok) {
        setLiveStatus(payload.message || "캡처 완료", "text-success");
      } else {
        setLiveStatus(payload.message || "캡처에 실패했습니다.", "text-danger");
      }
    } catch (error) {
      setLiveStatus("캡처 요청 중 오류가 발생했습니다.", "text-danger");
    }
  };

  if (liveCaptureButton) {
    liveCaptureButton.addEventListener("click", captureLivePreview);
  }

  const downloadForm = document.getElementById("download-form");
  const downloadProgress = document.getElementById("download-progress");
  const progressBar = document.getElementById("download-progress-bar");
  const downloadStatus = document.getElementById("download-status");
  const gdriveButtons = document.querySelectorAll(".gdrive-path-button");
  const gdriveSelects = document.querySelectorAll(".gdrive-path-select");
  let cachedGdrivePaths = null;

  const bindSelectsToInputs = () => {
    gdriveSelects.forEach((select) => {
      const inputId = select.dataset.bindInput;
      const targetInput = inputId ? document.getElementById(inputId) : null;
      if (!targetInput) return;
      select.addEventListener("change", () => {
        if (select.value) {
          targetInput.value = select.value;
        }
      });
    });
  };

  const populateGdriveSelects = (paths) => {
    gdriveSelects.forEach((select) => {
      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "폴더를 선택하세요";
      select.appendChild(placeholder);

      paths.forEach((path) => {
        const option = document.createElement("option");
        option.value = path;
        option.textContent = path;
        select.appendChild(option);
      });
    });
  };

  const loadGdrivePaths = async (triggerButton) => {
    if (cachedGdrivePaths) return cachedGdrivePaths;
    const originalText = triggerButton?.textContent;
    if (triggerButton) {
      triggerButton.disabled = true;
      triggerButton.textContent = "불러오는 중...";
    }

    try {
      const response = await fetch("{{ url_for('gdrive_folders') }}");
      const payload = await response.json();
      if (!response.ok || !payload.ok) {
        throw new Error(payload.message || "Google Drive 경로를 불러오지 못했습니다.");
      }
      cachedGdrivePaths = payload.folders || [];
      populateGdriveSelects(cachedGdrivePaths);
      return cachedGdrivePaths;
    } catch (error) {
      alert(error.message || "Google Drive 호출 중 오류가 발생했습니다.");
      return [];
    } finally {
      if (triggerButton) {
        triggerButton.disabled = false;
        triggerButton.textContent = originalText || "경로 불러오기";
      }
    }
  };

  const setupGdriveButtons = () => {
    bindSelectsToInputs();
    gdriveButtons.forEach((button) => {
      const targetId = button.dataset.target;
      const select = targetId ? document.getElementById(targetId) : null;
      if (!select) return;

      button.addEventListener("click", async () => {
        await loadGdrivePaths(button);
        select.classList.remove("d-none");
        select.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });
    });
  };

  if (downloadForm) {
    let timerId;

    const updateProgress = (value, stateClass = "bg-info") => {
      progressBar.style.width = `${value}%`;
      progressBar.className = `progress-bar ${stateClass}`;
    };

    const startProgress = () => {
      downloadProgress.classList.remove("d-none");
      updateProgress(6);
      timerId = setInterval(() => {
        const current = parseFloat(progressBar.style.width) || 0;
        const next = Math.min(current + Math.random() * 12, 92);
        updateProgress(next);
      }, 400);
    };

    const finishProgress = (ok) => {
      clearInterval(timerId);
      updateProgress(100, ok ? "bg-success" : "bg-danger");
    };

    downloadForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const videoUrl = document.getElementById("video_url").value;
      const uploadAfter = document.getElementById("upload_after").checked;

      if (!videoUrl) {
        downloadStatus.textContent = "링크를 입력하세요.";
        return;
      }

      startProgress();
      downloadStatus.textContent = "다운로드 중...";

      try {
        const response = await fetch("{{ url_for('download_action') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ video_url: videoUrl, upload_after: uploadAfter }),
        });

        const payload = await response.json();
        const success = response.ok && payload.ok;
        finishProgress(success);
        downloadStatus.textContent = payload.message || (success ? "다운로드 완료" : "다운로드에 실패했습니다.");
      } catch (error) {
        finishProgress(false);
        downloadStatus.textContent = "다운로드 요청 중 오류가 발생했습니다.";
      }
    });
  }

  setupGdriveButtons();
</script>
{% endblock %}
